name: Documentation and Security Scan

on:
  push:
    branches:
      - main
  pull_request:

jobs:
  build-docs:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4


      - name: Set up JDK 21
        uses: actions/setup-java@v3
        with:
          distribution: temurin
          java-version: 21


      - name: Generate Javadoc
        run: |
          mkdir -p ProyectoPrestamos/docs
          javadoc -d ProyectoPrestamos/docs -sourcepath ProyectoPrestamos/src/java -subpackages com.miempresa.bank


      - name: Generate UML diagrams
        run: |
          mkdir -p ProyectoPrestamos/docs/uml_diagrams
          # Solo se generarÃ¡ si existen bloques @startuml
          docker run --rm -v $GITHUB_WORKSPACE:/workspace plantuml/plantuml \
            -tpng /workspace/ProyectoPrestamos/src/java/com/miempresa/bank/**/*.java -o /workspace/ProyectoPrestamos/docs/uml_diagrams || true


      - name: Run Semgrep Scan
        run: |
          mkdir -p ProyectoPrestamos/docs/reports
          docker run --rm -v $GITHUB_WORKSPACE:/src returntocorp/semgrep \
            semgrep ci --config=p/ci --config=p/security-audit --json > ProyectoPrestamos/docs/reports/semgrep_report.json || true


      - name: Convert Semgrep JSON to Markdown
        run: |
          sudo apt-get update && sudo apt-get install -y jq
          echo "# Semgrep Report" > ProyectoPrestamos/docs/reports/semgrep_report.md
          TOTAL=$(jq '.results | length' ProyectoPrestamos/docs/reports/semgrep_report.json)
          echo "**Total hallazgos:** $TOTAL" >> ProyectoPrestamos/docs/reports/semgrep_report.md
          if [ "$TOTAL" -gt 0 ]; then
            echo "| Archivo | Regla | Severidad | Mensaje |" >> ProyectoPrestamos/docs/reports/semgrep_report.md
            echo "|--------|------|-----------|---------|" >> ProyectoPrestamos/docs/reports/semgrep_report.md
            jq -r '.results[] | "| \(.path) | \(.check_id) | \(.extra.severity) | \(.extra.message) |"' \
               ProyectoPrestamos/docs/reports/semgrep_report.json >> ProyectoPrestamos/docs/reports/semgrep_report.md
          else
            echo " No se encontraron bugs ni vulnerabilidades." >> ProyectoPrestamos/docs/reports/semgrep_report.md
          fi


      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v5
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ProyectoPrestamos/docs
